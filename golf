#include <iostream>
#include <fstream>
#include <sstream>
#include <map>
#include <vector>
#include <algorithm>

using namespace std;

struct Round {
    string name;  // Player's name
    int score;    // Score
    string club;  // Club name
};

// Trim from both sides of string
string trim(const string& str) {
    size_t first = str.find_first_not_of(" \t\r\n");
    if (first == string::npos) return ""; // Empty or all spaces
    size_t last = str.find_last_not_of(" \t\r\n");
    return str.substr(first, (last - first + 1));
}

//Processing file function
bool processFile(const string& filename, map<string, vector<Round>>& data, map<string, vector<string>>& clubs) {
    ifstream file(filename);
    if (!file) {
        cerr << "Error: The specified file cannot be opened!" << endl;
        return false;
    }

    string line;
    while (getline(file, line)) {
        if (line.empty()) continue; // Skip empty lines

        stringstream ss(line);
        string location, golfClub, player, scoreStr;
        int score;

        if (!getline(ss, location, ';') || !getline(ss, golfClub, ';') ||
            !getline(ss, player, ';') || !getline(ss, scoreStr, ';')) {
            cerr << "Error: The specified file has an erroneous line!" << endl;
            cerr << "Problematic line: " << line << endl;
            return false;
        }

        location = trim(location);
        golfClub = trim(golfClub);
        player = trim(player);
        scoreStr = trim(scoreStr);

        if (location.empty() || golfClub.empty() || player.empty() || scoreStr.empty()) {
            cerr << "Error: A line has an empty value!" << endl;
            cerr << "Problematic line: " << line << endl;
            return false;
        }

        try {
            score = stoi(scoreStr);
        } catch (const invalid_argument&) {
            cerr << "Error: Invalid score format in line: " << line << endl;
            return false;
        } catch (const out_of_range&) {
            cerr << "Error: Score out of range in line: " << line << endl;
            return false;
        }

        data[player].push_back({player, score, golfClub});
        clubs[location].push_back(golfClub);
    }
    file.close();
    return true;
}

// Print function for "played [player]" command. The function also calculates the player's HCP to print the according strings.
void displayPlayed(const map<string, vector<Round>>& data, const string& player) {
    auto it = data.find(player);
    if (it == data.end()) {
        cout << "Error: The player hasn't played any rounds!" << endl;
        return;
    }

    vector<Round> rounds = it->second;

    sort(rounds.begin(), rounds.end(), [](const Round& a, const Round& b) {
        if (a.score == b.score) return a.club < b.club;
        return a.score < b.score;
    });

    int numRounds = rounds.size();
    if (numRounds < 3) {
        cout << player << " has too few rounds for a handicap:" << endl;
    } else {
        int sum = 0, count = min(numRounds, 5);
        for (int i = 0; i < count; i++) sum += rounds[i].score;
        double hcp = static_cast<double>(sum) / count;
        cout << player << " has a HCP of " << hcp << " with following results:" << endl;
    }

    for (const auto& round : rounds) {
        cout << round.club << " : " << round.score << endl;
    }
}

// Print function for "clubs [location]" command
void displayClubs(const map<string, vector<string>>& clubs, const string& location) {
    auto it = clubs.find(location);
    if (it == clubs.end()) {
        cout << "Error: The given location not found!" << endl;
        return;
    }

    vector<string> clubList = it->second;
    sort(clubList.begin(), clubList.end());

    for (const auto& club : clubList) {
        cout << "--" << club << endl;
    }
}

//Print function for "rounds [club]" command
void displayRounds(const map<string, vector<Round>>& data, const string& club) {
    vector<Round> rounds;
    for (const auto& player : data) {
        for (const auto& round : player.second) {
            if (round.club == club) {
                rounds.push_back(round);
            }
        }
    }

    if (rounds.empty()) {
        cout << "Error: The given club not found!" << endl;
        return;
    }

    sort(rounds.begin(), rounds.end(), [](const Round& a, const Round& b) {
        return a.score < b.score;
    });

    for (const auto& round : rounds) {
        cout << round.name << " : " << round.score << endl;
    }
}

int main() {
    string filename;
    cout << "Input file: ";
    cin >> filename;

    map<string, vector<Round>> data;
    map<string, vector<string>> clubs;
    if (!processFile(filename, data, clubs)) {
        return EXIT_FAILURE;
    }

    string command, argument;
    while (true) {
        cout << "> ";
        cin >> command;
        cin.ignore(); // ensures getline function actually reads the argument after the cin command.
        getline(cin, argument);
        argument = trim(argument);

        if (command == "exit") {
            break;
        } else if (command == "played") {
            displayPlayed(data, argument);
        } else if (command == "clubs") {
            displayClubs(clubs, argument);
        } else if (command == "rounds") {
            displayRounds(data, argument);
        } else {
            cout << "Unknown command!" << endl;
        }
    }

    return EXIT_SUCCESS;
}
